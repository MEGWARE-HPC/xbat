user              root;
worker_processes  8;

error_log  /var/log/nginx/error.log;

events {
    worker_connections  1024;
}

# Stream module for TCP proxying with SSL termination
stream {
    upstream mongodb {
        server #MONGODB_HOST#:27017;
    }

    upstream clickhouse_native {
        server #CLICKHOUSE_HOST#:9000;
    }

    upstream clickhouse_postgres {
        server #CLICKHOUSE_HOST#:9005;
    }

    upstream clickhouse_http {
        server #CLICKHOUSE_HOST#:8123;
    }

    # MongoDB with SSL termination
    server {
        listen #MONGODB_PORT# ssl;
        proxy_pass mongodb;
        
        ssl_certificate #SSL_CERTIFICATE#;
        ssl_certificate_key #SSL_CERTIFICATE_KEY#;
        ssl_protocols TLSv1.2 TLSv1.3;
        proxy_connect_timeout 5s;
    }

    # ClickHouse native protocol with SSL termination
    server {
        listen #CLICKHOUSE_NATIVE_PORT# ssl;
        proxy_pass clickhouse_native;
        
        ssl_certificate #SSL_CERTIFICATE#;
        ssl_certificate_key #SSL_CERTIFICATE_KEY#;
        ssl_protocols TLSv1.2 TLSv1.3;
        proxy_connect_timeout 5s;
    }

    # ClickHouse PostgreSQL-compatible protocol without SSL
    # Nginx SSL not working with PgWire protocol
    # TODO implement SSL at pgbouncer or clickhouse level
    server {
        listen #CLICKHOUSE_PG_PORT#;
        proxy_pass clickhouse_postgres;
        
        proxy_connect_timeout 5s;
    }

    # ClickHouse HTTP protocol with SSL termination
    server {
        listen #CLICKHOUSE_HTTP_PORT# ssl;
        proxy_pass clickhouse_http;
        
        ssl_certificate #SSL_CERTIFICATE#;
        ssl_certificate_key #SSL_CERTIFICATE_KEY#;
        ssl_protocols TLSv1.2 TLSv1.3;
        proxy_connect_timeout 5s;
    }
}

http {

	include       /etc/nginx/mime.types;
	default_type  application/octet-stream;

	log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
		'$status $body_bytes_sent "$http_referer" '
		'"$http_user_agent" "$http_x_forwarded_for"';

	access_log  /var/log/nginx/access.log  main;

	sendfile       on;
	tcp_nopush     on;
	tcp_nodelay    off;

	keepalive_timeout  65;

	client_max_body_size 0;

	gzip  on;
    gzip_types text/plain text/css application/json application/javascript font/woff font/woff2 text/javascript;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_min_length 256;

    upstream docker-xbat-backend {
        server xbat-backend:8001;
    }

    upstream docker-xbat-ui {
        server xbat-ui:8003;
    }

    server {
        listen 7000 ssl;
        listen [::]:7000 ssl;

        # ssl redirection (use $http_host to have same port as http request, e.g. for ssh tunneling)
        error_page 497 301 =307 https://$http_host$request_uri;

        access_log /var/log/nginx/data-access.log combined;

        ssl_certificate #SSL_CERTIFICATE#;
        ssl_certificate_key #SSL_CERTIFICATE_KEY#;

        client_max_body_size 10M;
        proxy_read_timeout 60s;

        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Proto $scheme;
        

        location / {
            proxy_pass http://docker-xbat-ui;
            proxy_redirect http://docker-xbat-ui/ $scheme://$http_host/;
        }

        # /import route with higher read timeout and increased client body size
        location ~ /benchmarks/import {
            client_max_body_size 2G;
            proxy_pass http://docker-xbat-backend;
            proxy_redirect http://docker-xbat-backend/ $scheme://$http_host/;
            proxy_read_timeout 300s;
            proxy_buffering off;

            
        }

        # /export route with higher read timeout
        location ~ /benchmarks/export {
            proxy_pass http://docker-xbat-backend;
            proxy_redirect http://docker-xbat-backend/ $scheme://$http_host/;
            proxy_read_timeout 300s;
            proxy_buffering off;
        }

        location ~ /(api/v1|oauth|swagger)/ {
            proxy_pass http://docker-xbat-backend;
            proxy_redirect http://docker-xbat-backend/ $scheme://$http_host/;
        }
    }

}